<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>当前活动（简单版）</title>
  <style>
    body { text-align: center; font-family: "PingFang SC", "Microsoft YaHei", Arial, sans-serif; }
    h1, #now, #detail, #others { text-align: center; }
    button { margin: 10px auto; display: block; }
    #now { font-size: 1.6em; margin-top: 1em; }
    #detail { font-size: 1.1em; margin-top: 0.7em; }
    #others { margin-top: 1.6em; color: #677; font-size: 14px; }
  </style>
</head>
<body>
  <h1>当前活动</h1>
  <div id="now">正在加载…</div>
  <div id="detail"></div>
  <div id="others"></div>
  <button id="reload">重新加载 1.txt</button>

  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script>
    // 工具函数
    const parseTimeMin = s => {
      if (!s) return null;
      const [hh, mm] = s.split(':').map(x => parseInt(x, 10) || 0);
      return hh * 60 + mm;
    };
    const fmt = m => `${String(Math.floor(m / 60)).padStart(2, '0')}:${String(m % 60).padStart(2, '0')}`;
    function getISOWeekNumber(d) {
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    }
    const weekdayStr = n => ["日","一","二","三","四","五","六"][n%7];

    // 活动插入辅助
    function withBreaks(classes) {
      if (!classes || !classes.length) return [];
      let result = [];
      for (let i = 0; i < classes.length; i++) {
        const c = classes[i];
        // 记录当前课程
        result.push({
          ...c,
          is_break: false
        });

        // 判断与下节课的间隙，若间隔较长插入大课间
        if (i < classes.length - 1) {
          const end = parseTimeMin(c.end_time);
          const nextStart = parseTimeMin(classes[i + 1].start_time);
          const gap = nextStart - end;
          // 课间处理
          if (gap >= 35) {
            // 35分钟以上视为"大课间"
            result.push({
              subject: "大课间",
              start_time: fmt(end),
              end_time: fmt(nextStart),
              is_break: true,
              big: true
            });
          } else if (gap >= 5) {
            // 其它课间
            result.push({
              subject: "课间",
              start_time: fmt(end),
              end_time: fmt(nextStart),
              is_break: true
            });
          }
        }
      }
      return result;
    }

    // 回退数据
    const fallback = {
      subjects: [{"name":"语文","simplified_name":"语"},{"name":"数学","simplified_name":"数"},{"name":"英语","simplified_name":"英"},{"name":"历史","simplified_name":"历"},{"name":"政治","simplified_name":"政"},{"name":"物理","simplified_name":"物"},{"name":"化学","simplified_name":"化"},{"name":"生物","simplified_name":"生"},{"name":"地理","simplified_name":"地"},{"name":"信息技术","simplified_name":"信"},{"name":"体育","simplified_name":"体"},{"name":"自习","simplified_name":"自"},{"name":"通用技术","simplified_name":"技"},{"name":"音乐","simplified_name":"音"},{"name":"美术","simplified_name":"美"},{"name":"选修课","simplified_name":"选"},{"name":"社团","simplified_name":"社"},{"name":"心理","simplified_name":"心"},{"name":"早读","simplified_name":"早"},{"name":"班会","simplified_name":"班"},{"name":"周测","simplified_name":"测"},{"name":"人工智能","simplified_name":"智"},{"name":"劳动","simplified_name":"劳"},{"name":"晚读","simplified_name":"读"}],
      schedules: [
        {"name":"新课表","classes":[{"subject":"早读","start_time":"07:25:00","end_time":"07:50:00"},{"subject":"政治","start_time":"07:58:00","end_time":"08:40:00"},{"subject":"语文","start_time":"08:48:00","end_time":"09:30:00"},{"subject":"自习","start_time":"09:58:00","end_time":"10:40:00"},{"subject":"英语","start_time":"10:48:00","end_time":"11:30:00"},{"subject":"数学","start_time":"11:38:00","end_time":"12:20:00"},{"subject":"生物","start_time":"14:35:00","end_time":"15:20:00"},{"subject":"体育","start_time":"15:28:00","end_time":"16:15:00"},{"subject":"班会","start_time":"16:23:00","end_time":"17:10:00"},{"subject":"晚读","start_time":"18:55:00","end_time":"19:05:00"},{"subject":"自习","start_time":"19:05:00","end_time":"20:20:00"},{"subject":"自习","start_time":"20:28:00","end_time":"21:20:00"}],"enable_day":1,"weeks":"odd"},
        {"name":"新课表","classes":[{"subject":"早读","start_time":"07:25:00","end_time":"07:50:00"},{"subject":"政治","start_time":"07:58:00","end_time":"08:40:00"},{"subject":"语文","start_time":"08:48:00","end_time":"09:30:00"},{"subject":"自习","start_time":"09:58:00","end_time":"10:40:00"},{"subject":"英语","start_time":"10:48:00","end_time":"11:30:00"},{"subject":"数学","start_time":"11:38:00","end_time":"12:20:00"},{"subject":"生物","start_time":"14:35:00","end_time":"15:20:00"},{"subject":"体育","start_time":"15:28:00","end_time":"16:15:00"},{"subject":"班会","start_time":"16:23:00","end_time":"17:10:00"},{"subject":"晚读","start_time":"18:55:00","end_time":"19:05:00"},{"subject":"自习","start_time":"19:05:00","end_time":"20:20:00"},{"subject":"自习","start_time":"20:28:00","end_time":"21:20:00"}],"enable_day":1,"weeks":"even"},
        {"name":"新课表","classes":[{"subject":"早读","start_time":"07:25:00","end_time":"07:50:00"},{"subject":"音乐","start_time":"07:58:00","end_time":"08:40:00"},{"subject":"历史","start_time":"08:48:00","end_time":"09:30:00"},{"subject":"数学","start_time":"09:58:00","end_time":"10:40:00"},{"subject":"英语","start_time":"10:48:00","end_time":"11:30:00"},{"subject":"英语","start_time":"11:38:00","end_time":"12:20:00"},{"subject":"地理","start_time":"14:35:00","end_time":"15:20:00"},{"subject":"体育","start_time":"15:28:00","end_time":"16:15:00"},{"subject":"自习","start_time":"16:23:00","end_time":"17:10:00"},{"subject":"晚读","start_time":"18:55:00","end_time":"19:05:00"},{"subject":"自习","start_time":"19:05:00","end_time":"20:20:00"},{"subject":"自习","start_time":"20:28:00","end_time":"21:20:00"}],"enable_day":2,"weeks":"all"},
        {"name":"新课表","classes":[{"subject":"早读","start_time":"07:25:00","end_time":"07:50:00"},{"subject":"数学","start_time":"07:58:00","end_time":"08:40:00"},{"subject":"数学","start_time":"08:48:00","end_time":"09:30:00"},{"subject":"体育","start_time":"09:58:00","end_time":"10:40:00"},{"subject":"语文","start_time":"10:48:00","end_time":"11:30:00"},{"subject":"英语","start_time":"11:38:00","end_time":"12:20:00"},{"subject":"生物","start_time":"14:35:00","end_time":"15:20:00"},{"subject":"心理","start_time":"15:28:00","end_time":"16:15:00"},{"subject":"自习","start_time":"16:23:00","end_time":"17:10:00"},{"subject":"晚读","start_time":"18:55:00","end_time":"19:05:00"},{"subject":"自习","start_time":"19:05:00","end_time":"20:20:00"},{"subject":"自习","start_time":"20:28:00","end_time":"21:20:00"}],"enable_day":3,"weeks":"all"},
        {"name":"新课表","classes":[{"subject":"早读","start_time":"07:25:00","end_time":"07:50:00"},{"subject":"英语","start_time":"07:58:00","end_time":"08:40:00"},{"subject":"地理","start_time":"08:48:00","end_time":"09:30:00"},{"subject":"语文","start_time":"09:58:00","end_time":"10:40:00"},{"subject":"政治","start_time":"10:48:00","end_time":"11:30:00"},{"subject":"劳动","start_time":"11:38:00","end_time":"12:20:00"},{"subject":"体育","start_time":"14:35:00","end_time":"15:20:00"},{"subject":"数学","start_time":"15:28:00","end_time":"16:15:00"},{"subject":"自习","start_time":"16:23:00","end_time":"17:10:00"},{"subject":"晚读","start_time":"18:55:00","end_time":"19:05:00"},{"subject":"自习","start_time":"19:05:00","end_time":"20:20:00"},{"subject":"自习","start_time":"20:28:00","end_time":"21:20:00"}],"enable_day":4,"weeks":"all"},
        {"name":"新课表","classes":[{"subject":"早读","start_time":"07:25:00","end_time":"07:50:00"},{"subject":"信息技术","start_time":"07:58:00","end_time":"08:40:00"},{"subject":"数学","start_time":"08:48:00","end_time":"09:30:00"},{"subject":"美术","start_time":"09:58:00","end_time":"10:40:00"},{"subject":"语文","start_time":"10:48:00","end_time":"11:30:00"},{"subject":"语文","start_time":"11:38:00","end_time":"12:20:00"},{"subject":"英语","start_time":"14:35:00","end_time":"15:20:00"},{"subject":"历史","start_time":"15:28:00","end_time":"16:15:00"},{"subject":"自习","start_time":"16:23:00","end_time":"17:10:00"},{"subject":"晚读","start_time":"18:55:00","end_time":"19:05:00"},{"subject":"自习","start_time":"19:05:00","end_time":"20:20:00"},{"subject":"自习","start_time":"20:28:00","end_time":"21:20:00"}],"enable_day":5,"weeks":"all"}
      ]
    };

    async function loadData() {
      try {
        const res = await fetch('./1.txt', {cache:'no-store'});
        if (!res.ok) throw new Error('fetch fail');
        const txt = await res.text();
        const doc = jsyaml.load(txt);
        return (doc && doc.schedules) ? doc : fallback;
      } catch {
        return fallback;
      }
    }

    function scheduleActiveForWeek(schedule, now){
      const w = (schedule.weeks || 'all');
      if(w === 'all') return true;
      const weekNo = getISOWeekNumber(now);
      if(w === 'odd') return weekNo % 2 === 1;
      if(w === 'even') return weekNo % 2 === 0;
      return true;
    }

    function getScheduleForDay(data, enableDay, now){
      const arr = (data.schedules || []).filter(s=>Number(s.enable_day)===Number(enableDay));
      for(const c of arr) if(scheduleActiveForWeek(c,now)) return c;
      return arr[0] || null;
    }

    function buildFullDayClasses(data, now){
      // 返回当天完整的课程/课间list（含断层课间）
      const dow = now.getDay();
      if(dow < 1 || dow > 5) return [];
      const sched = getScheduleForDay(data, dow, now);
      if(!sched) return [];
      let arr = sched.classes || [];
      // 排序，理论上已排序
      arr = arr.slice().sort((a,b)=>parseTimeMin(a.start_time)-parseTimeMin(b.start_time));
      return withBreaks(arr);
    }

    function findCurrentActivity(full, now){
      const minNow = now.getHours()*60+now.getMinutes();
      for(const item of full){
        const st = parseTimeMin(item.start_time), en = parseTimeMin(item.end_time);
        if(st != null && en != null && minNow >= st && minNow < en){
          return item;
        }
      }
      return null;
    }

    function findNextActivity(full, now){
      const minNow = now.getHours()*60+now.getMinutes();
      for(const item of full){
        const st = parseTimeMin(item.start_time);
        if(st != null && st > minNow) return item;
      }
      return null;
    }

    let currentData = null;
    async function refresh(){
      if(!currentData) currentData = await loadData();
      const now = new Date();
      const dow = now.getDay();
      const fullList = buildFullDayClasses(currentData, now); // 含课间

      const nowEl = document.getElementById('now');
      const detEl = document.getElementById('detail');
      const othersEl = document.getElementById('others');

      if(dow < 1 || dow > 5){
        nowEl.innerText = "今天是周末";
        detEl.innerText = "";
        othersEl.innerText = "";
        return;
      }

      const cur = findCurrentActivity(fullList, now);
      if(cur){
        nowEl.innerText = cur.subject;
        detEl.innerText = `时间：${cur.start_time.slice(0,5)} - ${cur.end_time.slice(0,5)}`;
        // 上一节和下一节
        let pre = null, nxt = null;
        for(let i=0;i<fullList.length;i++){
          if(fullList[i] === cur){
            pre = fullList[i-1]||null;
            nxt = fullList[i+1]||null;
            break;
          }
        }
        othersEl.innerHTML =
          (pre ? `上一活动：${pre.subject}（${pre.end_time.slice(0,5)}下课）<br>` : '') +
          (nxt ? `下一活动：${nxt.subject}（${nxt.start_time.slice(0,5)}上课）` : '');
      } else {
        const next = findNextActivity(fullList, now);
        if(next){
          nowEl.innerText = '当前是空闲时段';
          detEl.innerText = `下一活动：${next.subject}，时间：${next.start_time.slice(0,5)} - ${next.end_time.slice(0,5)}`;
          // 上一个
          let pre = null;
          for(let i=0;i<fullList.length;i++)if(parseTimeMin(fullList[i].start_time)<=now.getHours()*60+now.getMinutes())pre=fullList[i];
          othersEl.innerHTML =
            (pre ? `上一活动：${pre.subject}（${pre.end_time.slice(0,5)}下课）<br>` : '') +
            '';
        }else{
          nowEl.innerText = "今天活动全部结束";
          detEl.innerText = "";
          othersEl.innerText = "";
        }
      }
    }

    document.getElementById('reload').onclick = async ()=>{
      currentData = await loadData();
      refresh();
    };

    (async ()=>{
      currentData = await loadData();
      refresh();
      setInterval(refresh, 15000);
    })();
  </script>
</body>
</html>
